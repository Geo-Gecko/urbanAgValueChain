<!DOCTYPE html>
<html wtx-context="FF4526E2-E70C-44E5-900C-5575BADB43F5"><head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<title>KCCA-Urban Agriculture ValueChain</title>

	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<link rel="stylesheet" href="css/leaflet.css">
	<link rel="stylesheet" href="css/L.css">
	<script src="js/leaflet.js"></script>
	<!--	<script src="js/jquery-3.1.1.min.js"></script>-->
	<link href='css/MarkerCluster.css' rel='stylesheet' />
	<link href='css/jquery-ui.css' rel='stylesheet' />
	<link href='css/MarkerCluster.Default.css' rel='stylesheet' />
	<link href='css/kccaUrbanAg.css' rel='stylesheet' />
	<script type="text/javascript" src="js/Sidebar.js"></script>
	<link rel="stylesheet" type="text/css" href="css/Sidebar.css">
	<link href='css/easy-button.css' rel='stylesheet' />
	<link href='css/icontext.css' rel='stylesheet' />

	<!--[if lte IE 8]><link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.ie.css" /><![endif]-->

	<style>
		body {
			padding: 0;
			margin: 0;
		}

		html, body, #map {
			height: 100%;
		}

		.lorem {
			font-style: italic;
			color: #AAA;
		}
	</style>
	</head>
	<body>

		<!-- The Modal -->
		<div id="myModal" class="modal">

			<!-- Modal content -->
			<div class="modal-content">
				<div class="modal-header">
					<span class="close">&times;</span>
					<p id="modal-header" class="custom-count-header" style="font-size: 16px;">About this Portal </p>
				</div>
				<table id="modal-body" class="modal-body">
				</table>
			</div>

		</div>

		<div id="legend"></div>
		<div id="sidebarRight">
			<h1 id="h1element">What do you see?</h1>
			<span id="mapDescription"></span>
			<p id="selectionDisplay"><strong>Selected Parish: </strong><span id='parish'></span>
				<br>
				<strong>Selected SubCounty: </strong><span id='subCounty'></span></p>
		</div>	
		<div id="map"></div>

		<script src="js/leaflet-src.js"></script>
		<script src="js/L.js"></script>
		<script src="js/jquery.min.js"></script>
		<script src="js/d3.v3.min.js"></script>
		<script src="js/colorbrewer.js"></script>
		<script src="js/jquery-ui.min.js"></script>
		<script src='js/L.Control.Button.js'></script>
		<script src='js/easy-button.js'></script>
		<script src='js/leaflet.markercluster-src.js'></script>
		<script src='js/leaflet-omnivore.js'></script>
		<script src='./js/L.Control.Button.js'></script>
		<script src='./js/piechartAndLegend.js'></script>


		<script>

			//Get the selection Display
			var selectedDisplay = document.getElementById('selectionDisplay');

			// Get the modal
			var modal = document.getElementById('myModal');

			// Get the <span> element that closes the modal
			var span = document.getElementsByClassName("close")[0];

			// When the user clicks on <span> (x), close the modal
			span.onclick = function() {
				modal.style.display = "none";
			}

			// When the user clicks anywhere outside of the modal, close it
			window.onclick = function(event) {
				if (event.target == modal) {
					modal.style.display = "none";
				}
			}

			$('.modal-content').resizable({
				alsoResize: ".modal-dialog",
				minHeight: 150
			});
			$('.modal-content').draggable();

			$('#myModal').on('show.bs.modal', function () {
				$(this).find('.modal-body').css({
					'max-height':'100%'
				});
			});



			var map = L.map('map');

			map.setView([0.3193, 32.5953], 12);

			map.bounds = [],
				map.setMaxBounds([
				[0.6733,32.057],
				[-0.04,33.05]
			]);


			L.tileLayer("https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png", {
				maxZoom: 18,
				attribution: 'Powered by: <br> &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">Carto</a><br><a href="https://www.kcca.go.ug/" target="_blank"><img style="right: 0; width: 6em;" src="css/images/kcca_logo.svg" alt="KCCA"></a>&nbsp&nbsp<a href="https://geogecko.com/" target="_blank"><img style="right: 0; width: 12em" src="css/images/logo-full-no-text.svg" alt="GeoGecko"></a>',
				subdomains: 'abcd',
				minZoom: 12,	
				maxZoom: 18
			}).addTo(map);

			var sidebarRight = L.control.sidebar('sidebarRight', {
				closeButton: true,
				position: 'right'
			});
			map.addControl(sidebarRight);


			function style(feature) {
				if(feature.properties.SS_GROUP===1){
					return {
						fillColor: '#b3cde3',
						weight: 0.3,
						opacity: 1,
						color: 'black',
						fillOpacity: 0.7
					};	
				} else if(feature.properties.SS_GROUP===2){
					return {
						fillColor: '#fbb4ae',
						weight: 0.3,
						opacity: 1,
						color: 'black',
						fillOpacity: 0.7
					};	
				} else if(feature.properties.SS_GROUP===3){
					return {
						fillColor: '#ccebc5',
						weight: 0.3,
						opacity: 1,
						color: 'black',
						fillOpacity: 0.7
					};	
				} else if(feature.properties.SS_GROUP===4){
					return {
						fillColor: '#ffffb2',
						weight: 0.3,
						opacity: 1,
						color: 'black',
						fillOpacity: 0.7
					};	
				}

			}

			function getColor(d) {
				return d > 30  ? '#006837' :
				d > 20  ? '#31a354' :
				d > 10   ? '#78c679' :
				d > 5   ? '#c2e699' :
				d > 0   ? '#ffffcc' :
				'#ffffcc';
			}

			function styleGreenSpace(feature) {
				return {
					fillColor: getColor(feature.properties.greenSpace),
					weight: 0.3,
					opacity: 1,
					color: 'black',
					fillOpacity: 0.7
				};
			}


			var markersMarkets = L.markerClusterGroup({
				iconCreateFunction: function(cluster) {
					var childCount = cluster.getChildCount();
					return L.divIcon({className: 'Marketsicon clusterIcons', html: '<div><span>' + childCount + '</span></div>'});
				},
				polygonOptions: {
					opacity: 0,
					fillOpacity: 0
				}
			});

			var markersHotels = L.markerClusterGroup({
				iconCreateFunction: function(cluster) {
					var childCount = cluster.getChildCount();
					return L.divIcon({className: 'HotelsIcon clusterIcons', html: '<div><span>' + childCount + '</span></div>'});
				},
				polygonOptions: {
					opacity: 0,
					fillOpacity: 0
				}
			});

			var markersInputSuppliers = L.markerClusterGroup({
				iconCreateFunction: function(cluster) {
					var childCount = cluster.getChildCount();
					return L.divIcon({className: 'InputSuppliersIcon clusterIcons', html: '<div><span>' + childCount + '</span></div>'});
				},
				polygonOptions: {
					opacity: 0,
					fillOpacity: 0
				}
			});

			var markersProcessors = L.markerClusterGroup({
				iconCreateFunction: function(cluster) {
					var childCount = cluster.getChildCount();
					return L.divIcon({className: 'ProcessorsIcon clusterIcons', html: '<div><span>' + childCount + '</span></div>'});
				},
				polygonOptions: {
					opacity: 0,
					fillOpacity: 0
				}
			});

			var markersTraders = L.markerClusterGroup({
				iconCreateFunction: function(cluster) {
					var childCount = cluster.getChildCount();
					return L.divIcon({className: 'TradersIcon clusterIcons', html: '<div><span>' + childCount + '</span></div>'});
				},
				polygonOptions: {
					opacity: 0,
					fillOpacity: 0
				}
			});

			var markersConsumers = L.markerClusterGroup({
				iconCreateFunction: function(cluster) {
					var childCount = cluster.getChildCount();
					return L.divIcon({className: 'ConsumersIcon clusterIcons', html: '<div><span>' + childCount + '</span></div>'});
				},
				polygonOptions: {
					opacity: 0,
					fillOpacity: 0
				}
			});

			var markersFocusGroupDiscussions = L.markerClusterGroup({
				iconCreateFunction: function(cluster) {
					var childCount = cluster.getChildCount();
					return L.divIcon({className: 'FocusGroupDiscussionsIcon clusterIcons', html: '<div><span>' + childCount + '</span></div>'});
				},
				polygonOptions: {
					opacity: 0,
					fillOpacity: 0
				}
			});
			var markersIndividualProducers = L.markerClusterGroup({
				iconCreateFunction: function(cluster) {
					var childCount = cluster.getChildCount();
					return L.divIcon({className: 'IndividualProducersIcon clusterIcons', html: '<div><span>' + childCount + '</span></div>'});
				},
				polygonOptions: {
					opacity: 0,
					fillOpacity: 0
				}
			});

			var datasetFocusGroup = [];

			var focusGroupDataLayer;

			function eachLayer(marker) {
				var ltg = marker.toGeoJSON();
				var popup = L.popup()
				.setContent("<b>" + ltg.properties.TYPE + ".</b></br>" +
							"<b>Principle Enterprise: </b>" + ltg.properties["Principle enterprise"] + "</br>" +
							"<b>Gender: </b>" + ltg.properties.Gender + "</br>" +
							"<b>Age Group: </b>" + ltg.properties["Age group"] + " years old</br></br></br>" +
							"<b>Click point for more Information</b>"
						   );
				var popupOther = L.popup()
				.setContent("<b>" + ltg.properties.TYPE + ".</b></br>" +
							"<b>Name: </b>" + ltg.properties["Interviewee name"] === "_" ? "Not Available" : ltg.properties["Interviewee name"] + "</br>"
						   );


				marker.on('mouseover', function (e) {
					this.openPopup();
				});
				marker.on('mouseout', function (e) {
					this.closePopup();
				});

				marker.on('click', function(d) {
					var questions = [];
					d3.select('#sidebarRight').select('table').remove();
					d3.select('#sidebarRight').selectAll('svg').remove();

					var table = d3.select('#sidebarRight').append('table')
					var thead = table.append('thead')
					var	tbody = table.append('tbody');

					// append the header row
					thead.append('tr')
						.selectAll('th')
						.data(['Question', 'Answer']).enter()
						.append('th')
						.text(function (column) { return column; });


					var questionURL = './data/' + d.target.feature.properties.TYPE +'.json'; 

					d3.json(questionURL, function (error, list) {
						console.log(error);
						var listName = ltg.properties.TYPE
						for (var i = 0; i < list.QuestionsList.length; i++) {
							for (var i = 0; i < list.QuestionsList.length; i++) {
								if(d.target.feature.properties[list.QuestionsList[i].Question] !== ""){
									questions.push({Question : list.QuestionsList[i].Question, Answer : d.target.feature.properties[list.QuestionsList[i].Question]});
								}
							}
						}

						// create a row for each object in the data
						var rows = tbody.selectAll('tr')
						.data(questions)
						.enter()
						.append('tr');


						var cells = rows.selectAll('td')
						.data(function (row) {
							return ['Question', 'Answer'].map(function (column) {
								return {column: column, value: row[column]};	
							});
						})
						.enter()
						.append('td')
						.text(function (d) {
							return d.value;});


					});

				})

				if (ltg.properties.TYPE === "Individual Producer") {
					markersIndividualProducers.addLayer(marker.on("click", function (){
						if(!sidebarRight.isVisible()) {
							sidebarRight.toggle();
						}
					}).bindPopup(popup));	
				} else if (ltg.properties.TYPE === "Input Supplier") {
					markersInputSuppliers.addLayer(marker.on("click", function (){
						if(!sidebarRight.isVisible()) {
							sidebarRight.toggle();
						}
					}).bindPopup(popup));	
				} else if (ltg.properties.TYPE === "Processor") {
					markersProcessors.addLayer(marker.on("click", function (){
						if(!sidebarRight.isVisible()) {
							sidebarRight.toggle();
						}
					}).bindPopup(popup));	
				} else if (ltg.properties.TYPE === "Trader") {
					markersTraders.addLayer(marker.on("click", function (){
						if(!sidebarRight.isVisible()) {
							sidebarRight.toggle();
						}
					}).bindPopup(popup));	
				} else if (ltg.properties.TYPE === "Consumer") {
					markersConsumers.addLayer(marker.on("click", function (){
						if(!sidebarRight.isVisible()) {
							sidebarRight.toggle();
						}
					}).bindPopup(popup));	
				} else if (ltg.properties.TYPE === "FGD") {
					datasetFocusGroup.push(ltg.properties);
					markersFocusGroupDiscussions.addLayer(marker.on("click", function (){
						if(!sidebarRight.isVisible()) {
							sidebarRight.toggle();
						}
					}).bindPopup(popup));
				} else if (ltg.properties.TYPE === "Hotel") {
					markersHotels.addLayer(marker.on("click", function (){
						if(!sidebarRight.isVisible()) {
							sidebarRight.toggle();
						}
					}).bindPopup(popupOther));
				} else if (ltg.properties.TYPE === "Market") {
					markersMarkets.addLayer(marker.bindPopup(popupOther));
				}
			}

			var omnivoreStyleHelper = L.geoJSON(null, {
				pointToLayer: function (feature, latlng) {
					function colour(feature) {
						if (feature.properties.TYPE === "Individual Producer") {
							return	"#FFB400"
						} else if (feature.properties.TYPE === "Hotel") {
							return	"#f88379"
						} else if (feature.properties.TYPE === "Market") {
							return	"#76a646"
						} else if (feature.properties.TYPE === "FGD") {
							return	"#AAB931"
						} else if (feature.properties.TYPE === "Input Supplier") {
							return	"#377eb8"
						} else if (feature.properties.TYPE === "Processor") {
							return	"#984ea3"
						} else if (feature.properties.TYPE === "Trader") {
							return	"#f781bf"
						} else if (feature.properties.TYPE === "Consumer") {
							return	"#a65628"
						} 
					}
					var geojsonMarkerOptions = {
						radius: 5,
						fillColor: colour(feature),
						color: "#000",
						weight: 1,
						opacity: 1,
						fillOpacity: 0.8
					};
					return L.circleMarker(latlng, geojsonMarkerOptions);
				}
			});

			// this can be any kind of omnivore layer
			var dataset = omnivore.csv('./data/kcca_urbanAgValueChain_.csv', null, omnivoreStyleHelper).on('ready', function() {
				dataset.eachLayer(eachLayer);
			});


			var dataLayer;
			var dataLayer1;
			var dataLayer2;
			var dataLayer3;



			$.getJSON('./data/distanceToMarket.geojson', function(data){

				function onEachFeature(feature, featureLayer) {
					featureLayer.bindPopup(feature.properties.Name + "km");
				}
				dataLayer3 = L.geoJson(data, {
					style: function (feature) {
						return {
							weight: 0.3,
							opacity: 1,
							color: '#3B5323',	
							fillOpacity: feature.properties.FromBreak / 3
						}

					},
					onEachFeature: onEachFeature
				})
			});

			$.getJSON('./data/kampalaParishes.geojson', function(data){
				dataLayer = L.geoJson(data, {
					style: style
				}).on('click', function (d) {
					if(!sidebarRight.isVisible()) {
						sidebarRight.toggle();
					}


					selectedDisplay.style.display = "block";

					document.getElementById('parish').innerHTML = d.layer.feature.properties.pname;
					document.getElementById('subCounty').innerHTML = d.layer.feature.properties.s;


					d3.select('#sidebarRight').selectAll('svg').remove();
					d3.select('#sidebarRight').selectAll('table').remove();

					var dataset = [
						{"title" : "Age Groups" ,"label" : "Age Group (0-17)", "value" : d.layer.feature.properties.F_BA_0_17_},
						{"label" : "Age Group (18-30)", "value" : d.layer.feature.properties.F_18_30_GG},
						{"label" : "Age Group (31-59)", "value" : d.layer.feature.properties.F_BA31_59},
						{"label" : "Age Group (60+)", "value" : d.layer.feature.properties.F_BA60_}
					];

					drawChart(dataset);


					var dataset1 = [
						{"title" : "Roof Type", "label" : "Iron Sheet", "value" : d.layer.feature.properties.Iron_sheet},
						{"label" : "Tiles", "value" : d.layer.feature.properties.Tiles},
						{"label" : "Asbestos", "value" : d.layer.feature.properties.Asbestes},
						{"label" : "Concrete", "value" : d.layer.feature.properties.Concrete},
						{"label" : "Tin", "value" : d.layer.feature.properties.Tin},
						{"label" : "Thatch", "value" : d.layer.feature.properties.Thatch}
					];

					drawChart(dataset1);

					var dataset2 = [
						{"title" : "Types of Structure", "label" : "Detatched Houses", "value" : d.layer.feature.properties.Detached_H},
						{"label" : "Semi Detatched Houses", "value" : d.layer.feature.properties.Semi_Detac},
						{"label" : "Multiple Rooms", "value" : d.layer.feature.properties.Room_Or_Ro},
						{"label" : "Servant Quarters", "value" : d.layer.feature.properties.Servant_Qu},
						{"label" : "Tenement", "value" : d.layer.feature.properties.Tenement__},
						{"label" : "Other", "value" : d.layer.feature.properties.Others}
					];

					drawChart(dataset2);

					var dataset3 = [
						{"title" : "Type of Household Head", "label" : "Male Headed", "value" : d.layer.feature.properties.F_Mhhead},
						{"label" : "Female Headed", "value" : d.layer.feature.properties.F_Fhhead}
					];

					drawChart(dataset3);
				});

				dataLayer1 = L.geoJson(data, {
					style: styleGreenSpace
				}).addTo(map);
				
				
				var array = ['#ffffcc', '#c2e699', '#78c679', '#31a354', '#006837'];
							var arrayLabel = ["0% - 5%", "6% - 10%", "11% - 20%", "21% - 30%", "31% and above"];
				
				addLegend(array, arrayLabel, "%age of Greenspace");

				dataLayer1.on('click', function (d) {
					if(!sidebarRight.isVisible()) {
						sidebarRight.toggle();
					}


					selectedDisplay.style.display = "block";

					document.getElementById("mapDescription").innerHTML = "The green space analysis is based on Sentinel 2 satellite images from 2018.<br>" +
						"The result quantifies the amount of green space in each parish for both years based on 10 x 10 meters pixels<br>" +
						"that are classified as predominantly green or not.";


					document.getElementById('parish').innerHTML = d.layer.feature.properties.pname;
					document.getElementById('subCounty').innerHTML = d.layer.feature.properties.s;


					d3.select('#sidebarRight').selectAll('svg').remove();
					d3.select('#sidebarRight').selectAll('table').remove();

					var dataset = [
						{"title" : "Percentage of GreenSpace", "label" : "Greenspace", "value" : d.layer.feature.properties.greenSpace},
						{"label" : "Not Greenspace", "value" : 100 - d.layer.feature.properties.greenSpace}
					];

					drawChart(dataset);
				});


				dataLayer2 = L.geoJson(data, {
					style: function(feature){
						for (var i = 0; i < datasetFocusGroup.length; i++) {
							if (feature.properties.pname_small === datasetFocusGroup[i].RealParish_individual.toLowerCase() && datasetFocusGroup[i]["Principle enterprise"] === "Mushroom" ){
								return {
									fillColor: "#2b8cbe",
									weight: 0.3,
									opacity: 1,
									color: 'black',
									fillOpacity: 0.7
								};
							} else if (feature.properties.pname_small === datasetFocusGroup[i].RealParish_individual.toLowerCase() && datasetFocusGroup[i]["Principle enterprise"] === "Leafy vegetables" ){
								return {
									fillColor: "#66c2a4",
									weight: 0.3,
									opacity: 1,
									color: 'black',
									fillOpacity: 0.7
								};
							}
						}
						return {
							weight: 0.3,
							opacity: 1,
							color: 'black',
							fillOpacity: 0
						};
					}
				}).on('click', function (d) {
					if(!sidebarRight.isVisible()) {
						sidebarRight.toggle();
					}


					selectedDisplay.style.display = "block";

					document.getElementById('parish').innerHTML = d.layer.feature.properties.pname;
					document.getElementById('subCounty').innerHTML = d.layer.feature.properties.s;

					var dataset = [
						{"title" : "Male/Female Percentage", "label" : "Males Interviewed", "value" : 11.86440677966102},
						{"label" : "Females Interviewed", "value" : 88.13559322033898}
					];

					drawChart(dataset);

					var questions = [];
					d3.select('#sidebarRight').select('table').remove();
					d3.select('#sidebarRight').selectAll('svg').remove();

					var table = d3.select('#sidebarRight').append('table')
					var thead = table.append('thead')
					var	tbody = table.append('tbody');

					// append the header row
					thead.append('tr')
						.selectAll('th')
						.data(['Question', 'Answer']).enter()
						.append('th')
						.text(function (column) { return column; });


					d3.json('./data/questionsFGD.json', function (error, list) {

						var dataset = [];
						var arrayAnswers = [];

						for (var i = 0; i < datasetFocusGroup.length; i++) {
							if (d.layer.feature.properties.pname_small === datasetFocusGroup[i].RealParish_individual.toLowerCase()){

								dataset.push(datasetFocusGroup[i]);

							}
						}

						for (var j = 0; j < list.QuestionsList.length; j++) {
							var q = list.QuestionsList[j].Question;
							function arrayList() {
								for (var k = 0; k < dataset.length; k++) {
									arrayAnswers.push(dataset[k][list.QuestionsList[j].Question])
								} 
							}
							arrayList(q);
						}



						var listAns = [], size = dataset.length;
						while (arrayAnswers.length > 0)
							listAns.push(arrayAnswers.splice(0, size));

						for (var j = 0; j < list.QuestionsList.length; j++) {
							var q = list.QuestionsList[j].Question;

							questions.push({Question : q, Answer : listAns[j].filter(function (item, pos) {
								return listAns[j].indexOf(item) === pos;
							})})
						}

						// create a row for each object in the data
						var rows = tbody.selectAll('tr')
						.data(questions)
						.enter()
						.append('tr');

						var cells = rows.selectAll('td')
						.data(function (row) {
							return ['Question', 'Answer'].map(function (column) {
								return {column: column, value: row[column]};
							});
						})
						.enter()
						.append('td')
						.text(function (d) {return d.value;});



					});


				});
			}).done(function(){

				buttons.GreenSpace.state('remove-markers');
			});


			var buttons = {
				GreenSpace: L.easyButton({
					position: 'topright',
					states: [{
						stateName: 'add-markers',
						icon: '<img alt="GreenSpace" src="./css/images/leaf-solid.svg" height="40" width="40" align="left" style="opacity:0.4 "/><span id="textGreenspace" class="btn--text"><font color="black"><b>GreenSpace</b></font></span>',
						title: 'add random markers',
						onClick: function(control) {

							selectedDisplay.style.display = "none";

							map.addLayer(dataLayer1);
							map.removeLayer(dataLayer);
							map.removeLayer(dataLayer2);
							map.removeLayer(markersIndividualProducers);
							map.removeLayer(markersFocusGroupDiscussions);
							map.removeLayer(markersInputSuppliers);
							map.removeLayer(markersConsumers);
							map.removeLayer(markersProcessors);
							map.removeLayer(markersTraders);
							map.removeLayer(markersMarkets);
							map.removeLayer(markersHotels);
							map.removeLayer(dataLayer3);
							control.state('remove-markers');
							buttons.focusGroupDiscussion.state('add-markers');
							buttons.Grouping.state('add-markers');
							buttons.Hotels.state('add-markers');
							buttons.Markets.state('add-markers');
							buttons.TrueStories.state('add-markers');


							document.getElementById("mapDescription").innerHTML = "The green space analysis is based on Sentinel 2 satellite images from 2018.<br>" +
								"The result quantifies the amount of green space in each parish for both years based on 10 x 10 meters pixels<br>" +
								"that are classified as predominantly green or not.";

							d3.select('#sidebarRight').selectAll('svg').remove();
							d3.select('#sidebarRight').selectAll('table').remove();

							var array = ['#ffffcc', '#c2e699', '#78c679', '#31a354', '#006837'];
							var arrayLabel = ["0% - 5%", "6% - 10%", "11% - 20%", "21% - 30%", "31% and above"];

							addLegend(array, arrayLabel, "%age of Greenspace");

							var dataset = [
								{"title" : "Percentage of GreenSpace", "label" : "Greenspace", "value" : 9.086484227},
								{"label" : "Not Greenspace", "value" : 90.913515773}
							];

							drawChart(dataset);
						}
					}, {
						stateName: 'remove-markers',
						icon: '<img alt="GreenSpace" src="./css/images/leaf-solid-On.svg" height="40" width="40" align="left"/><span id="textGreenspace" class="btn--text"><font color="black"><b>GreenSpace</b></font></span>',
						onClick: function(control) {
							map.removeLayer(dataLayer1);
							control.state('add-markers');
						},
						title: 'remove markers'
					}]
				}),
				Grouping: L.easyButton({
					position: 'topright',
					states: [{
						stateName: 'add-markers',
						icon: '<img alt="Grouping" src="./css/images/th-large-solid.svg" height="40" width="40" align="left" style="opacity:0.4 "/><span id="text" class="btn--text"><font color="black"><b>Similar Parishes</b></font></span>',
						title: 'add random markers',
						onClick: function(control) {

							selectedDisplay.style.display = "none";

							map.addLayer(dataLayer);
							map.removeLayer(dataLayer1);
							map.removeLayer(dataLayer2);
							map.removeLayer(markersIndividualProducers);
							map.removeLayer(markersFocusGroupDiscussions);
							map.removeLayer(markersInputSuppliers);
							map.removeLayer(markersConsumers);
							map.removeLayer(markersProcessors);
							map.removeLayer(markersTraders);
							map.removeLayer(markersMarkets);
							map.removeLayer(dataLayer3);
							map.removeLayer(markersHotels);
							control.state('remove-markers');
							buttons.focusGroupDiscussion.state('add-markers');
							buttons.GreenSpace.state('add-markers');
							buttons.Hotels.state('add-markers');
							buttons.Markets.state('add-markers');
							buttons.TrueStories.state('add-markers');


							document.getElementById("mapDescription").innerHTML = "The selection of these areas of study was undertaken using a cluster analysis algorithm which utilized machine learning methods to determine natural groupings (most correlated) within the parishes basing on socio-economic indicators from the 2014 Uganda Bureau of Statistics (UBOS) Census. Using this algorithm, the parishes in Kampala were categorized into 4 groups based on where the following socio-economic parameters correlated most:<br>" +
								" Group 1: older age, lower population density, more permanent roofs, more male-headed households <br>" +
								" Group 2: middle age, lower population density, more permanent roofs, <br>" +
								" Group 3: younger age, medium population density, slightly more temporary roofs, <br>" +
								" Group 4: younger age, higher population density, more temporary roofs, fewer male-headed households<br>";


							var array = ['#b3cde3', '#fbb4ae', '#ccebc5', '#ffffb2'];
							var arrayLabel = ["Group: 1", "Group: 2", "Group: 3", "Group: 4"];

							addLegend(array, arrayLabel, "Similar Parishes");



							d3.select('#sidebarRight').selectAll('svg').remove();
							d3.select('#sidebarRight').selectAll('table').remove();

							var dataset = [
								{"title" : "Age Groups" ,"label" : "Age Group (0-17)", "value" : 37.61752577},
								{"label" : "Age Group (18-30)", "value" : 37.45856907},
								{"label" : "Age Group (31-59)", "value" : 22.70515464},
								{"label" : "Age Group (60+)", "value" : 2.212371134}
							];

							drawChart(dataset);


							var dataset1 = [
								{"title" : "Roof Type","label" : "Iron Sheet", "value" : 81.05979381},
								{"label" : "Tiles", "value" : 7.65257732},
								{"label" : "Asbestos", "value" : 4.68556701},
								{"label" : "Concrete", "value" : 5.853608247},
								{"label" : "Tin", "value" : 0.628865979},
								{"label" : "Thatch", "value" : 0.107216495}
							];

							drawChart(dataset1);

							var dataset2 = [
								{"title" : "Types of Structure","label" : "Detatched Houses", "value" : 21.06804124},
								{"label" : "Semi Detatched Houses", "value" : 23.91752577},
								{"label" : "Multiple Rooms", "value" : 3.645360825},
								{"label" : "Servant Quarters", "value" : 4.474226804},
								{"label" : "Tenement", "value" : 4.649484536},
								{"label" : "Other", "value" : 2.851546392}
							];

							drawChart(dataset2);

							var dataset3 = [
								{"title" : "Type of Household Head","label" : "Male Headed", "value" : 70.18247423},
								{"label" : "Female Headed", "value" : 29.81752577}
							];

							drawChart(dataset3);
						}
					}, {
						icon: '<img alt="Grouping" src="./css/images/th-large-solid-On.svg" height="40" width="40" align="left"/><span id="text" class="btn--text"><font color="black"><b>Similar Parishes</b></font></span>',
						stateName: 'remove-markers',
						onClick: function(control) {
							map.removeLayer(dataLayer);
							control.state('add-markers');
						},
						title: 'remove markers'
					}]
				}),
				focusGroupDiscussion: L.easyButton({
					position: 'topright',
					states: [{
						stateName: 'add-markers',
						icon: '<img alt="focusGroupDiscussion" src="./css/images/users-solid.svg" height="40" width="40" align="left" style="opacity:0.4 "/><span id="text" class="btn--text"><font color="black"><b>Focus Group Discussions</b></font></span>',
						title: 'add random markers',
						onClick: function(control) {


							selectedDisplay.style.display = "none";

							map.addLayer(dataLayer2);
							map.removeLayer(dataLayer);
							map.removeLayer(dataLayer1);
							map.removeLayer(markersIndividualProducers);
							map.removeLayer(markersFocusGroupDiscussions);
							map.removeLayer(markersInputSuppliers);
							map.removeLayer(markersConsumers);
							map.removeLayer(markersProcessors);
							map.removeLayer(markersTraders);
							map.removeLayer(markersMarkets);
							map.removeLayer(dataLayer3);
							map.removeLayer(markersHotels);
							control.state('remove-markers');
							buttons.GreenSpace.state('add-markers');
							buttons.Grouping.state('add-markers');
							buttons.Hotels.state('add-markers');
							buttons.Markets.state('add-markers');
							buttons.TrueStories.state('add-markers');


							document.getElementById("mapDescription").innerHTML = "Within the parishes selected for urban farmer surveys, the selection of the FGDs was based on ‘purposive’ and ‘convenience’ sampling among those involved in either growing leafy vegetables or mushrooms. Community leaders helped identify these farmers. Additional individual farmers were interviewed which were identified with the support of members of the respective FGDs, community leaders, input suppliers and traders.";


							var array = ['#2b8cbe', '#66c2a4'];
							var arrayLabel = ["Mushrooms", "Leafy Vegetables"];

							addLegend(array, arrayLabel, "Focus Group Discussions held");



							d3.select('#sidebarRight').selectAll('svg').remove();
							d3.select('#sidebarRight').selectAll('table').remove();

							var dataset = [
								{"title" : "Male/Female Percentage", "label" : "Males Interviewed", "value" : 11.86440677966102},
								{"label" : "Females Interviewed", "value" : 88.13559322033898}
							];

							drawChart(dataset);
						}
					}, {
						icon: '<img alt="focusGroupDiscussion" src="./css/images/users-solid-On.svg" height="40" width="40" align="left"/><span id="text" class="btn--text"><font color="black"><b>Focus Group Discussions</b></font></span>',
						stateName: 'remove-markers',
						onClick: function(control) {
							map.removeLayer(dataLayer2);
							control.state('add-markers');
						},
						title: 'remove markers'
					}]
				}),
				TrueStories: L.easyButton({
					position: 'topright',
					states: [{
						stateName: 'add-markers',
						icon: '<img alt="TrueStories" src="./css/images/user-solid.svg" height="40" width="40" align="left" style="opacity:0.4 "/><span id="text" class="btn--text"><font color="black"><b>True Stories</b></font></span>',
						title: 'add random markers',
						onClick: function(control) {


							selectedDisplay.style.display = "none";

							map.addLayer(markersIndividualProducers);
							map.addLayer(markersFocusGroupDiscussions);
							map.addLayer(markersInputSuppliers);
							map.addLayer(markersConsumers);
							map.addLayer(markersProcessors);
							map.addLayer(markersTraders);
							map.removeLayer(dataLayer);
							map.removeLayer(dataLayer1);
							map.removeLayer(dataLayer2);
							map.removeLayer(markersMarkets);
							map.removeLayer(markersHotels);
							map.removeLayer(dataLayer3);
							control.state('remove-markers');
							buttons.focusGroupDiscussion.state('add-markers');
							buttons.GreenSpace.state('add-markers');
							buttons.Grouping.state('add-markers');
							buttons.Hotels.state('add-markers');
							buttons.Markets.state('add-markers');


							document.getElementById("mapDescription").innerHTML = "Relative Locations visited for interviews and clicking on the data points will give information about them collected in the survey phase of the project.";

							var array = ['#FFB400', '#AAB931',"#377eb8", "#a65628", "#984ea3", "#f781bf"];
							var arrayLabel = ["Individual Producers", "Focus Group Discussions", "Input Suppliers", "Consumers", "Processors", "Traders"];

							addLegend(array, arrayLabel, "True Stories for", "circle");


							d3.select('#sidebarRight').selectAll('svg').remove();
							d3.select('#sidebarRight').selectAll('table').remove();

							var dataset = [
								{"title" : "Male/Female Percentage", "label" : "Males Interviewed", "value" : 24.32432432432432},
								{"label" : "Females Interviewed", "value" : 75.67567567567568}
							];

							//							drawChart(dataset);

						}
					}, {
						icon: '<img alt="TrueStories" src="./css/images/user-solid-On.svg" height="40" width="40" align="left"/><span id="text" class="btn--text"><font color="black"><b>True Stories</b></font></span>',
						stateName: 'remove-markers',
						onClick: function(control) {
							map.removeLayer(markersIndividualProducers);
							map.removeLayer(markersFocusGroupDiscussions);
							map.removeLayer(markersInputSuppliers);
							map.removeLayer(markersConsumers);
							map.removeLayer(markersProcessors);
							map.removeLayer(markersTraders);
							control.state('add-markers');
						},
						title: 'remove markers'
					}]
				}),
				Hotels: L.easyButton({
					position: 'topright',
					states: [{
						stateName: 'add-markers',
						icon: '<img alt="Hotels" src="./css/images/concierge-bell-solid.svg" height="40" width="40" align="left" style="opacity:0.4 "/><span id="text" class="btn--text"><font color="black"><b>Hotels</b></font></span>',
						title: 'add random markers',
						onClick: function(control) {
							
							selectedDisplay.style.display = "none";

							map.addLayer(markersHotels);
							map.removeLayer(dataLayer);
							map.removeLayer(dataLayer1);
							map.removeLayer(dataLayer2);
							map.removeLayer(markersIndividualProducers);
							map.removeLayer(markersFocusGroupDiscussions);
							map.removeLayer(markersInputSuppliers);
							map.removeLayer(markersConsumers);
							map.removeLayer(markersProcessors);
							map.removeLayer(markersTraders);
							map.removeLayer(markersMarkets);
							map.removeLayer(dataLayer3);
							control.state('remove-markers');
							buttons.focusGroupDiscussion.state('add-markers');
							buttons.GreenSpace.state('add-markers');
							buttons.Grouping.state('add-markers');
							buttons.Markets.state('add-markers');
							buttons.TrueStories.state('add-markers');


							document.getElementById("mapDescription").innerHTML = "As the hotel market comes out as such a large consumer below map in figure 14 shows where other large hotels are located that are likely to have similar demands for mushrooms. Data about consumption was collected from Kabira Country Club and Protea Hotel by Mariott.<br>" +
								"These were two hotels which consumed an average of 560kg per day and seven supermarkets which consumed an estimate of 600kg per week.";


							var array = ["#f781bf"];
							var arrayLabel = ["Hotels"];

							addLegend(array, arrayLabel, "Hotels", "circle");

							if(sidebarRight.isVisible()) {
								sidebarRight.toggle();
							}


							d3.select('#sidebarRight').selectAll('svg').remove();
							d3.select('#sidebarRight').selectAll('table').remove();


						}
					}, {
						icon: '<img alt="Hotels" src="./css/images/concierge-bell-solid-On.svg" height="40" width="40" align="left"/><span id="text" class="btn--text"><font color="black"><b>Hotels</b></font></span>',
						stateName: 'remove-markers',
						onClick: function(control) {
							map.removeLayer(markersHotels);
							control.state('add-markers');
						},
						title: 'remove markers'
					}]
				}),
				Markets: L.easyButton({
					position: 'topright',
					states: [{
						stateName: 'add-markers',
						icon: '<img alt="Markets" src="./css/images/shopping-basket-solid.svg" height="40" width="40" align="left" style="opacity:0.4 "/><span id="text" class="btn--text"><font color="black"><b>Distance to Market</b></font></span>',
						title: 'add random markers',
						onClick: function(control) {

							selectedDisplay.style.display = "none";

							map.addLayer(markersMarkets);
							map.addLayer(dataLayer3);
							map.removeLayer(dataLayer);
							map.removeLayer(dataLayer1);
							map.removeLayer(dataLayer2);
							map.removeLayer(markersIndividualProducers);
							map.removeLayer(markersFocusGroupDiscussions);
							map.removeLayer(markersInputSuppliers);
							map.removeLayer(markersConsumers);
							map.removeLayer(markersProcessors);
							map.removeLayer(markersTraders);
							map.removeLayer(markersHotels);
							control.state('remove-markers');
							buttons.focusGroupDiscussion.state('add-markers');
							buttons.GreenSpace.state('add-markers');
							buttons.Grouping.state('add-markers');
							buttons.Hotels.state('add-markers');
							buttons.TrueStories.state('add-markers');


							document.getElementById("mapDescription").innerHTML = "The drive time from each market was calculated based on the length of the roadnd visualized with 1km breaks to give an idea how far a market is to different areas within the city which is important in determining which market to sell to." ;


							var array = ['#ffffff','#ced4c8','#9da991', '#6c7e5a', '#3b5323'];
							var arrayLabel = ["0 - 1km", "1 - 2km", "2 - 3km", "3 - 4km", "4 - 5km"];

							addLegend(array, arrayLabel, "Road Distance to Markets");

							if(sidebarRight.isVisible()) {
								sidebarRight.toggle();
							}



							d3.select('#sidebarRight').selectAll('svg').remove();
							d3.select('#sidebarRight').selectAll('table').remove();



						}
					}, {
						icon: '<img alt="Markets" src="./css/images/shopping-basket-solid-On.svg" height="40" width="40" align="left"/><span id="text" class="btn--text"><font color="black"><b>Distance to Market</b></font></span>',
						stateName: 'remove-markers',
						onClick: function(control) {
							map.removeLayer(markersMarkets);
							map.removeLayer(dataLayer3);
							control.state('add-markers');
						},
						title: 'remove markers'
					}]
				}),
				invisible: L.easyButton({
					id: 'invisible',
					position: 'topright',
					states: [{
						stateName: 'add-markers',
						icon: '<img alt="invisible" src="./css/images/link-solid.svg" height="40" width="40" align="left" style="opacity:0"/>',
						title: 'add random markers',
						onClick: function(control) {
							control.state('remove-markers');

						}
					}, {
						icon: '<img alt="invisible" src="./css/images/link-solid.svg" height="40" width="40" align="left" style="opacity:0"/>',
						stateName: 'remove-markers',
						onClick: function(control) {
							control.state('add-markers');
						},
						title: 'remove markers'
					}]
				}),
				profitInValueChain: L.easyButton({
					position: 'topright',
					states: [{
						stateName: 'add-markers',
						icon: '<img alt="Markets" src="./css/images/money-bill-wave-solid.svg" height="40" width="40" align="left" style="opacity:0.4 "/><span id="text" class="btn--text"><font color="black"><b>Profit Margins</b></font></span>',
						title: 'add random markers',
						onClick: function(control) {
							control.state('remove-markers');


							selectedDisplay.style.display = "none";


							document.getElementById("mapDescription").innerHTML = "Profit margins for different entities between the Leafy Vegetable and Mushroom value chains." ;

							if(!sidebarRight.isVisible()) {
								sidebarRight.toggle();
							}

							$("#overlay").show();

							document.getElementById('parish').innerHTML = "N/A";
							document.getElementById('subCounty').innerHTML = "N/A";

							
							d3.select('#sidebarRight').selectAll('svg').remove();

							d3.select('#sidebarRight').selectAll('table').remove();

							d3.json("./data/treeMapLeafy.json", function(err, res) {
								if (!err) {
									var data = d3.nest().key(function(d) { return d; }).entries(res);
									main({title: "World Population"}, {key: "Leafy Vegetable Profits 'Shillings per Pile'", values: res[0].values});
								}
							});

							d3.json("./data/treeMapMushroom.json", function(err, res) {
								if (!err) {
									var data = d3.nest().key(function(d) { return d; }).entries(res);
									main({title: "World Population"}, {key: "Mushroom Profits 'Shillings per Kilo'", values: res[0].values});
								}
							});


						}
					}, {
						icon: '<img alt="Markets" src="./css/images/money-bill-wave-solid-On.svg" height="40" width="40" align="left"/><span id="text" class="btn--text"><font color="black"><b>Profit Margins</b></font></span>',
						stateName: 'remove-markers',
						onClick: function(control) {
							if(sidebarRight.isVisible()) {
								sidebarRight.toggle();
							}
							control.state('add-markers');
							$("#overlay").fadeOut();

						},
						title: 'remove markers'
					}]
				}),
				valueChain: L.easyButton('<img alt="Markets" src="./css/images/link-solid.svg" height="40" width="40" align="left"/><span id="text" class="btn--text"><font color="black"><b>See the Value Chain</b></font></span>', function(){
					window.open("./storyMap/index.html", "_blank");
				}),
				Info: L.easyButton({
					position: 'bottomright',
					id: 'info',
					states: [{
						stateName: 'add-markers',
						icon: '<img alt="Information" src="./css/images/info-solid.svg" height="20" width="20" align="left" style="opacity:0.4"/>',
						title: 'add random markers',
						onClick: function(control) {
							control.state('remove-markers');
							modal.style.display = "block";

						}
					}, {
						icon: '<img alt="Information" src="./css/images/info-solid-On.svg" height="20" width="20" align="left"/>',
						stateName: 'remove-markers',
						onClick: function(control) {
							control.state('add-markers');
							modal.style.display = "block";
						},
						title: 'remove markers'
					}]
				})
			}

			
			var defaults = {
								margin: {top: 24, right: 0, bottom: 0, left: 0},
								rootname: "TOP",
								format: ",d",
								title: "",
								width: +(d3.select("#sidebarRight.leaflet-control").select('h1').style('width').slice(0, -2)),
								height: +(d3.select("#sidebarRight.leaflet-control").select('h1').style('width').slice(0, -2))
							};
			
						function main(o, data) {
				var root,
					opts = $.extend(true, {}, defaults, o),
					formatNumber = d3.format(opts.format),
					rname = opts.rootname,
					margin = opts.margin,
					theight = 36 + 16;

				//				$('#sidebarRight').width(opts.width).height(opts.height);
				var width = opts.width - margin.left - margin.right,
					height = opts.height - margin.top - margin.bottom - theight,
					transitioning;

				var color = d3.scale.category20c();


				var x = d3.scale.linear()
				.domain([0, width])
				.range([0, width]);

				var y = d3.scale.linear()
				.domain([0, height])
				.range([0, height]);

				var treemap = d3.layout.treemap()
				.children(function(d, depth) { return depth ? null : d._children; })
				.sort(function(a, b) { return a.value - b.value; })
				.ratio(height / width * 0.5 * (1 + Math.sqrt(5)))
				.round(false);

				var svg = d3.select("#sidebarRight").append("svg")
				.attr("width", width + margin.left + margin.right)
				.attr("height", height + margin.bottom + margin.top)
				.style("margin-left", -margin.left + "px")
				.style("margin.right", -margin.right + "px")
				.append("g")
				.attr("transform", "translate(" + margin.left + "," + margin.top + ")")
				.style("shape-rendering", "crispEdges");

				var grandparent = svg.append("g")
				.attr("class", "grandparent");

				grandparent.append("rect")
					.attr("y", -margin.top)
					.attr("width", width)
					.attr("height", margin.top);

				grandparent.append("text")
					.attr("x", 6)
					.attr("y", 6 - margin.top)
					.attr("dy", ".75em");

				if (opts.title) {
					//					$("#sidebarRight").prepend("<p class='title'>" + opts.title + "</p>");
				}
				if (data instanceof Array) {
					root = { key: rname, values: data };
				} else {
					root = data;
				}

				initialize(root);
				accumulate(root);
				layout(root);
				
				display(root);

				if (window.parent !== window) {
					var myheight = document.documentElement.scrollHeight || document.body.scrollHeight;
					window.parent.postMessage({height: myheight}, '*');
				}

				function initialize(root) {
					root.x = root.y = 0;
					root.dx = width;
					root.dy = height;
					root.depth = 0;
				}

				// Aggregate the values for internal nodes. This is normally done by the
				// treemap layout, but not here because of our custom implementation.
				// We also take a snapshot of the original children (_children) to avoid
				// the children being overwritten when when layout is computed.
				function accumulate(d) {
					return (d._children = d.values)
						? d.value = d.values.reduce(function(p, v) { return p + accumulate(v); }, 0)
					: d.value;
				}

				// Compute the treemap layout recursively such that each group of siblings
				// uses the same size (1×1) rather than the dimensions of the parent cell.
				// This optimizes the layout for the current zoom state. Note that a wrapper
				// object is created for the parent node for each group of siblings so that
				// the parent’s dimensions are not discarded as we recurse. Since each group
				// of sibling was laid out in 1×1, we must rescale to fit using absolute
				// coordinates. This lets us use a viewport to zoom.
				function layout(d) {
					if (d._children) {
						treemap.nodes({_children: d._children});
						d._children.forEach(function(c) {
							c.x = d.x + c.x * d.dx;
							c.y = d.y + c.y * d.dy;
							c.dx *= d.dx;
							c.dy *= d.dy;
							c.parent = d;
							layout(c);
						});
					}
				}

				function display(d) {
					grandparent
						.datum(d.parent)
						.on("click", transition)
						.select("text")
						.text(name(d));

					var g1 = svg.insert("g", ".grandparent")
					.datum(d)
					.attr("class", "depth");

					var g = g1.selectAll("g")
					.data(d._children)
					.enter().append("g");

					g.filter(function(d) { return d._children; })
						.classed("children", true)
						.on("click", transition);

					var children = g.selectAll(".child")
					.data(function(d) { return d._children || [d]; })
					.enter().append("g");

					children.append("rect")
						.attr("class", "child")
						.call(rect)
						.append("title")
						.text(function(d) { return d.key + " (" + formatNumber(d.value) + ")"; });
					children.append("text")
						.attr("class", "ctext")
						.text(function(d) { return d.key; })
						.call(text2);

					g.append("rect")
						.attr("class", "parent")
						.call(rect);

					var t = g.append("text")
					.attr("class", "ptext")
					.attr("dy", ".75em")

					t.append("tspan")
						.text(function(d) { return d.key; });
					t.append("tspan")
						.attr("dy", "1.0em")
						.text(function(d) { return formatNumber(d.value); });
					t.call(text);

					g.selectAll("rect")
						.style("fill", function(d, i) { console.log(color(d.key)); return color(d.key) });

					function transition(d) {
						if (transitioning || !d) return;
						transitioning = true;

						var g2 = display(d),
							t1 = g1.transition().duration(750),
							t2 = g2.transition().duration(750);

						// Update the domain only after entering new elements.
						x.domain([d.x, d.x + d.dx]);
						y.domain([d.y, d.y + d.dy]);

						// Enable anti-aliasing during the transition.
						svg.style("shape-rendering", null);

						// Draw child nodes on top of parent nodes.
						svg.selectAll(".depth").sort(function(a, b) { return a.depth - b.depth; });

						// Fade-in entering text.
						g2.selectAll("text").style("fill-opacity", 0);

						// Transition to the new view.	
						t1.selectAll(".ptext").call(text).style("fill-opacity", 0);
						t1.selectAll(".ctext").call(text2).style("fill-opacity", 0);
						t2.selectAll(".ptext").call(text).style("fill-opacity", 1);
						t2.selectAll(".ctext").call(text2).style("fill-opacity", 1);
						t1.selectAll("rect").call(rect);
						t2.selectAll("rect").call(rect);

						// Remove the old node when the transition is finished.
						t1.remove().each("end", function() {
							svg.style("shape-rendering", "crispEdges");
							transitioning = false;
						});
					}

					return g;
				}

				function text(text) {
					text.selectAll("tspan")
						.attr("x", function(d) { return x(d.x) + 6; })
					text.attr("x", function(d) { return x(d.x) + 6; })
						.attr("y", function(d) { return y(d.y) + 6; })
						.style("opacity", function(d) { return this.getComputedTextLength() < x(d.x + d.dx) - x(d.x) ? 1 : 0; });
				}

				function text2(text) {
					text.attr("x", function(d) { return x(d.x + d.dx) - this.getComputedTextLength() - 6; })
						.attr("y", function(d) { return y(d.y + d.dy) - 6; })
						.style("opacity", function(d) { return this.getComputedTextLength() < x(d.x + d.dx) - x(d.x) ? 1 : 0; });
				}

				function rect(rect) {
					rect.attr("x", function(d) { return x(d.x); })
						.attr("y", function(d) { return y(d.y); })
						.attr("width", function(d) { return x(d.x + d.dx) - x(d.x); })
						.attr("height", function(d) { return y(d.y + d.dy) - y(d.y); });
				}

				function name(d) {
					return d.parent
						? name(d.parent) + " / " + d.key + " (" + formatNumber(d.value) + ")"
					: d.key + " (" + formatNumber(d.value) + ")";
				}
			}



			// add the buttons. iterates over the buttons objects
			for (var key in buttons) {
				if (buttons.hasOwnProperty(key)) {
					buttons[key].addTo(map)
				}
			}

			$('#invisible').parent().css('border', 0);

		</script>


	</body></html>